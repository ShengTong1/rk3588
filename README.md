# 灵枢智慧农业边缘智控系统

## 项目概述

基于RK3588平台的智能温室大棚控制系统，采用Qt5框架开发，集成YOLOv8目标检测、MQTT云端通信、传感器数据采集等功能。系统支持自动化控制补光灯、保温帘等设备，实现智能化农业管理。

## 核心功能

### 🌱 智能控制系统
- **智能遮光系统**: PWM调光控制，支持手动/自动模式
- **智能保温系统**: GPIO控制顶帘/侧帘独立操作
- **智能灌溉系统**: 水泵控制，支持手动启停；施药泵控制，支持独立操作
- **AI智能决策**: 基于光照强度自动控制遮光帘，支持开启/关闭切换
- **环境监测**: 温湿度、光照强度、土壤湿度实时监测

### 🤖 AI视觉检测
- **YOLOv8集成**: 基于RKNN-Toolkit-Lite2的实时目标检测
- **摄像头支持**: USB摄像头实时预览和检测
- **PyQt界面**: 独立的检测界面，支持一键切换

### ☁️ 云端通信
- **阿里云IoT**: MQTT协议数据上传下载
- **实时数据**: 每10秒自动上报设备状态
- **远程控制**: 支持云端指令下发控制

### 🖥️ 用户界面
- **现代化UI**: 基于Qt5的美观界面设计，1024×573分辨率
- **实时显示**: 温湿度圆形表盘、设备状态指示
- **窗口管理**: 支持全屏、最大化、窗口切换

## 技术架构

### 硬件平台
- **主控**: RK3588开发板
- **传感器**: AHT20(温湿度)、GY-30(光照)
- **执行器**: PWM补光灯、GPIO保温帘、水泵控制
- **摄像头**: USB摄像头

### 软件架构
- **框架**: Qt5 + C++11
- **AI引擎**: RKNN-Toolkit-Lite2
- **通信**: MQTT over SSL
- **界面**: Qt5

## 项目结构

```
qt_mainwindow/
├── src/                    # 源代码目录
│   ├── core/              # 核心模块
│   ├── ui/                # 界面管理
│   ├── hardware/          # 硬件控制
│   ├── device/            # 设备控制
│   ├── network/           # 网络通信
│   ├── integration/       # 系统集成
│   └── system/            # 系统管理
├── include/               # 头文件目录
├── pyqt/                  # YOLOv8 PyQt应用
├── *.sh                   # 启动和管理脚本
├── *.service              # 系统服务文件
└── README.md              # 项目文档
```

## 快速开始

### 编译运行
```bash
cd /home/elf/work/qt_mainwindow
qmake qt_mainwindow.pro && make
./wonderfulnewworld
```

### 一键启动（推荐）
```bash
cd /home/elf/work/qt_mainwindow
./start.sh
```

### 开机自启动
```bash
sudo ./install_autostart.sh
```

## 硬件配置

### GPIO配置
- GPIO3_C4: 顶帘开启
- GPIO4_B3: 顶帘关闭
- GPIO3_A3: 顶帘使能控制
- GPIO3_A0: 顶帘使能控制2（双步进电机驱动板）
- GPIO3_C5: 侧帘开启
- GPIO4_B2: 侧帘关闭
- GPIO3_B1: 侧帘使能控制
- GPIO3_A5: 侧帘使能控制2（双步进电机驱动板）
- GPIO3_A7: 水泵控制
- GPIO3_B6: 系统启动信号

### PWM配置
- pwmchip0: 补光灯控制（1000Hz频率）

### I2C传感器
- I2C7: GY-30光照传感器
- I2C7: AHT20温湿度传感器

## 系统服务

### 权限设置
```bash
./setup_hardware_permissions.sh
```

**重要**: 权限设置脚本已更新，新增了双使能引脚(96, 101)和施药泵控制引脚(97)的权限配置，确保遮光帘控制和施药泵功能正常工作。

## 🤖 AI智能决策功能

### 功能特性
- **默认状态**: 系统重启后默认关闭AI决策
- **智能控制**: 基于GY30光照传感器数据自动控制上遮光帘
- **决策逻辑**:
  - 光照强度 > 500 lux：自动开启上遮光帘
  - 光照强度 < 300 lux：自动关闭上遮光帘
- **操作时间**: 每次自动操作持续18秒
- **安全机制**: 操作期间手动控制被锁定，防止冲突
- **防抖动**: 2秒防抖动处理，避免频繁触发

### 使用方法
1. 点击主界面的"🤖 AI智能决策"按钮开启功能
2. 按钮变为绿色表示AI决策已开启
3. 系统将根据光照强度自动控制遮光帘
4. 再次点击按钮可关闭AI决策功能
5. 按钮变为灰色表示AI决策已关闭

### 配置参数
- 开帘光照阈值: 500 lux (可在`include/config/ai_config.h`中修改)
- 关帘光照阈值: 300 lux (可在`include/config/ai_config.h`中修改)
- 操作持续时间: 18秒 (可在`include/config/ai_config.h`中修改)
- 防抖动间隔: 2秒 (可在`include/config/ai_config.h`中修改)

## 🚰 智能灌溉系统

### 功能特性
- **水泵控制**: 通过GPIO3_A7引脚控制主水泵的开启/关闭
- **施药泵控制**: 通过GPIO3_A1引脚控制施药泵的独立操作
- **状态监控**: 实时显示水泵和施药泵的运行状态
- **手动操作**: 支持独立控制每个泵的启停

### 使用方法
1. 进入"智能灌溉系统"页面
2. 查看水泵和施药泵的当前状态
3. 点击对应的"开启"/"关闭"按钮控制泵的运行
4. 状态卡片会实时更新显示当前运行状态

### GPIO引脚配置
- 水泵控制: GPIO3_A7 (引脚103) - 高电平开启，低电平关闭
- 施药泵控制: GPIO3_A1 (引脚97) - 高电平开启，低电平关闭

## 配置说明

### MQTT配置
编辑 `include/config/aliyun_config.h` 配置阿里云三元组：
- ALIYUN_PRODUCT_KEY
- ALIYUN_DEVICE_NAME  
- ALIYUN_DEVICE_SECRET

### 传感器配置
编辑 `include/config/gpio_config.h` 配置GPIO引脚映射

### 遮光帘双使能引脚配置
为了支持双步进电机驱动板，系统配置了双使能引脚：

#### 顶部遮光帘
- **主使能引脚**: GPIO3_A3 (99) - 原有使能控制
- **副使能引脚**: GPIO3_A0 (96) - 新增使能控制，逻辑完全同GPIO3_A3

#### 侧面遮光帘
- **主使能引脚**: GPIO3_B1 (105) - 原有使能控制
- **副使能引脚**: GPIO3_A5 (101) - 新增使能控制，逻辑同GPIO3_B1

#### 控制逻辑
- 两个使能引脚始终保持相同的电平状态
- 低电平(0)：使能步进电机运行
- 高电平(1)：禁用步进电机（暂停状态）
- 确保两个步进电机驱动板同步工作

## 贡献

欢迎提交 3375218996@qq.com 来改进项目

## 联系方式

如有问题请提交 3375218996@qq.com
